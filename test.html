<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
    <link rel="stylesheet" href="myfile.css">
</head>
<body>
<div class="wrapper">
    <div class="box">
        <div class="box__title">
            <div class="box__title-text">Выберите друзей</div>
            <div class="box__title-close"><div class="close"></div></div>
        </div>
        <div class="box__content">
            <div class="box__filter">
                <div class="filter-left">
                    <label class="label">
                        <input type="text" class="input input-left" name="filter-left" placeholder="Начтине вводить имя друга">
                    </label>
                </div>
                <div class="filter-right">
                    <label class="label">
                        <input type="text" class="input input-right" name="filter-right" placeholder="Начтине вводить имя друга">
                    </label>
                </div>
            </div>
            <div class="block">
                <div class="block-content">
                    <div class="block-content__title">
                        Ваши друзья
                    </div>
                    <div class="block-content__body">
                        <ul class="block-content__list list-left-js">
                        </ul>
                    </div>
                </div>
                <div class="block-content">
                    <div class="block-content__title">
                        Друзья в списке
                    </div>
                    <ul class="block-content__body list-right-js">
                    </ul>
                </div>
            </div>
        </div>
        <div class="box__footer">
            <button class="btn-save">Сохранить</button>
        </div>

    </div>
</div>
<script id="user-template" type="text/x-handlebars-template">
        {{#each list}}
        <li class="user" draggable="true">
            <div class="user__content">
                <div class="user__photo" ><img src="{{photo}}" alt="" class="user__img"></div>
                <div class="user__name">{{userName}}</div>
            </div>
            <div class="user__remove"><div class="close"></div></div>
        </li>
        {{/each}}

</script>

<script id="user-template2" type="text/x-handlebars-template">
    {{#each list}}
    <li class="user" draggable="true">
        <div class="user__content">
            <div class="user__photo" ><img src="{{photo}}" alt="" class="user__img"></div>
            <div class="user__name">{{userName}}</div>
        </div>
        <div class="user__add"><div class="close"></div></div>
    </li>
    {{/each}}

</script>
<script>
    let content = {
        templateR: document.querySelector('#user-template').textContent,
        templateL: document.querySelector('#user-template2').textContent,
        listRight: document.querySelector('.list-right-js'),
        listLeft: document.querySelector('.list-left-js'),
        inputL: document.querySelector('.input-left'),
        inputR: document.querySelector('.input-right'),
        block: document.querySelector('.block'),
        btnSave: document.querySelector('.btn-save'),
        compR: function () {
            let self = this;
             return Handlebars.compile(self.templateR);
        },
        compL: function () {
            let self = this;
             return Handlebars.compile(self.templateL);
        },
        removeUser: function(elem,list) {
            for (let i = 0; i < list.length;i++){
                if(list[i].userName === elem) {
                    list.splice(i, 1);
                }
            }
        },
        addUser: function(elem,list) {
            list.push(elem)
        },
        dataF: function(elem) {
            let photo = elem.previousElementSibling.children[0].children[0].getAttribute('src');
            let user = elem.previousElementSibling.children[1].textContent;
            return {'userName':user,'photo':photo};
        },
        update:function (listL,listR) {
            this.listRight.innerHTML = this.compR()(listR);
            this.listLeft.innerHTML = this.compL()(listL);
        },
        check:function (full, chunk) {
            if (full.toLowerCase().indexOf(chunk.toLowerCase()) === -1) {
                return false;
            } else {
                return true;
            }
        }

    }
    var userListRight = {
        list:[{
            userName: "Yehuda Katz",
            photo: 'https://pp.userapi.com/c638324/v638324863/bbd5/JvAtEfnhYTI.jpg'
        },
        {
            userName: "Yehuda1 Katz",
            photo: 'https://pp.userapi.com/c638324/v638324863/bbd5/JvAtEfnhYTI.jpg'
        },
        {
            userName: "Yehuda1 Katz",
            photo: 'https://pp.userapi.com/c638324/v638324863/bbd5/JvAtEfnhYTI.jpg'
        },
        ]
    }

    var userListLeft = {
        list:[{
            userName: "Друзьякин1 Евгений",
            photo: 'https://pp.userapi.com/c622918/v622918902/1315a/O-iwiREkdo0.jpg'
        },
        {
            userName: "Друзьякин2 Евгений",
            photo: 'https://pp.userapi.com/c622918/v622918902/1315a/O-iwiREkdo0.jpg'
        },
        {
            userName: "Друзьякин3 Евгений",
            photo: 'https://pp.userapi.com/c622918/v622918902/1315a/O-iwiREkdo0.jpg'
        },
        {
            userName: "Друзьякин4 Евгений",
            photo: 'https://pp.userapi.com/c622918/v622918902/1315a/O-iwiREkdo0.jpg'
        },
        {
            userName: "Друзьякин5 Евгений",
            photo: 'https://pp.userapi.com/c622918/v622918902/1315a/O-iwiREkdo0.jpg'
        },
        {
            userName: "Друзьякин6 Евгений",
            photo: 'https://pp.userapi.com/c622918/v622918902/1315a/O-iwiREkdo0.jpg'
        },
        ]
    }

    userListLeft = JSON.parse(localStorage.dataL);
    userListRight = JSON.parse(localStorage.dataR);

    let sortL = {list:[]};
    let sortR = {list:[]};
    sortL.list = userListLeft.list
    sortR.list = userListRight.list
    content.update(sortL,sortR);



    content.block.addEventListener('click',function (e) {
        let elemL = e.target.classList.value === 'user__add'  ? e.target : e.target.parentElement.classList.value === 'user__add' ? e.target.parentElement : 0;
        let elemR = e.target.classList.value === 'user__remove'  ? e.target : e.target.parentElement.classList.value === 'user__remove' ? e.target.parentElement : 0;

        if(elemL){
            let data = content.dataF(elemL);
            content.removeUser(data.userName,userListLeft.list);
            content.addUser(data,userListRight.list)

        }
        if(elemR){
            let data = content.dataF(elemR);
            content.removeUser(data.userName,userListRight.list);
            content.addUser(data,userListLeft.list)
        }
        var eventL = new Event("keyup");
        content.inputL.dispatchEvent(eventL);
        var eventR = new Event("keyup");
        content.inputR.dispatchEvent(eventR);
        content.update(sortL,sortR);

    })


    content.inputL.addEventListener('keyup',function (e) {
        sortL.list = [];
        if(e.target.value.length){
            for (let i = 0; i < userListLeft.list.length; i++) {
                if(content.check(userListLeft.list[i].userName,e.target.value)){
                    sortL.list.push(userListLeft.list[i]);
                }
            }
            content.update(sortL,sortR);
        }else {
            sortL.list = userListLeft.list
            content.update(sortL,sortR);
        }
    })
    content.inputR.addEventListener('keyup',function (e) {
        sortR.list = [];
        if(e.target.value.length){
            for (let i = 0; i < userListRight.list.length; i++) {
                if(content.check(userListRight.list[i].userName,e.target.value)){
                    sortR.list.push(userListRight.list[i]);
                }
            }
            content.update(sortL,sortR);
        }else {
            sortR.list = userListRight.list
            content.update(sortL,sortR);
        }
    })
    
    content.btnSave.addEventListener('click',function () {
        localStorage.dataL = JSON.stringify(userListLeft);
        localStorage.dataR = JSON.stringify(userListRight);
    })


    function start(e) {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html',e.target.innerHTML)
    }

    function handleDragEnter(e) {
        e.preventDefault();
        return true;
    }
    function handleDragOver(e) {
        e.preventDefault();
        return true;
    }

    function handleDragDrop(e) {
        var data = e.dataTransfer.getData('text/html');
        console.log(e.target.parentNode);
        e.target.parentNode.appendChild('<li>sssss</li>')
        // e.target.parentNode.appendChild(document.getElementById(data));
        e.stopPropagation();
        return false;
    }

    content.listRight.addEventListener('dragover',handleDragOver, false);
    content.listRight.addEventListener('drop',handleDragDrop, false);
    content.listRight.addEventListener('dragenter',handleDragEnter, false);

    content.listLeft.addEventListener('dragover',handleDragOver, false);
    content.listLeft.addEventListener('drop',handleDragDrop, false);
    content.listLeft.addEventListener('dragenter',handleDragEnter, false);

    let list = document.getElementsByTagName('li')
        console.log(list);

    content.block.addEventListener('mousedown',function (e) {
        e.target.closest('li').addEventListener('dragstart', start, false);
    })

</script>
</body>
</html>